(*
Debug
=====

The debug file holds any files used for SRL debugging and logging. Debug usage
guidelines are as follows:
    * Use print('TRSMinimap.getDots()', TDebug.HEADER) to initilize a function header.
    * Use print('TRSMinimap.getDots(): '+toStr(result), TDebug.FOOTER) to signal the end of the function.
    * WARNING: If TDebug.HEADER is used, a TDebug.FOOTER MUST be called once before exiting the function.
    * Use print('Function/procedure name here', TDebug.SUB) for short functions that don't need a header/footer.
    * HINT: Always include the function's name in a TDebug.SUB to make it easier for developers.
    * Use print('Message', TDebug.ERROR) for error messages.
    * Use print('Message', TDebug.WARNING) for warnings.  If a lot of warnings are expected in a
      row, use print() once, followed by print('Message' TDebug.LOG).
    * Use print('Message') for informational messages (i.e. "Checking if..." or
      "Found...").
    * Use print('Message', TDebug.LOG) for specific information the user won't want to see, but
      will be useful for scripters to debug (i.e. "Found 20 pixels of the color
      12345678 with tolerance 15").
    * Use print('Message', TDebug.HINT) for scripting hints.
    * Use print('Message', TDebug.FATAL) to terminate the script.
*)

{$include_once globals.simba}
{$include_once ../utilities/time.simba}
{$include_once ../utilities/wrappers.simba}
{$include_once ../utilities/types/types.simba}
{$include_once ../utilities/drawing.simba}

{$f-}

(*
type TDebug
~~~~~~~~~~~

A set of enums used to distinguish between the types of SRL debugging.

Example:

.. code-block:: pascal

    print('Failed to open bank', TDebug.ERROR);
*)
{$s+}
type
  TDebug = (DEBUG, HEADER, SUB, FOOTER, LOG, HINT, WARNING, ERROR, FATAL);
{$s-}

{*
var Internal Debug
~~~~~~~~~~~~~~~~~~

Internal SRL debug variables:
    * __logFile: The handle of the SRL log file.
    * __debugLevel: Used for debug indenting. Makes it easier to read & follow.
*}
var
  __logFile = -1;
  __debugLevel = 1;

(*
var External Debug
~~~~~~~~~~~~~~~~~~

External SRL debug variables that can be set scripts:
    * logPath: string; The path the save the SRL log file. Default path is SRL-6/logs/.
    * disableSRLLog: boolean; Disables saving debug to a log file.  Default false.
    * disableSRLDebug: boolean; Disables SRL functions from printing to the debug box.  Default false.
    * addTimeStamp: boolean; if enabled will add the time before all debug messages.
*)
var
  logPath = includePath + 'SRL-6/logs/';
  disableSRLLog = false;
  disableSRLDebug = false;
  addTimeStamp = false;

{*
__openLogFile
~~~~~~~~~~~~~

.. code-block:: pascal

    function __openLogFile(): boolean;

Creates the SRL log file.

.. note::

    by Coh3n
    Last Modified: Feb. 20th, 2012 by Coh3n

Example:

.. code-block:: pascal

    __openLogFile();

*}
function __openLogFile(): boolean;
var
  fileName, start: string;
begin
  if (disableSRLLog) then
    exit;

  if (not directoryExists(logPath)) then
    forceDirectories(logPath);

  start := replace(theDate(DATE_DAY)+' at '+theTime(), ':', '.', [rfReplaceAll]);

  // make sure it's a valid file name (Windows)
  fileName := 'SRL log ('+start+').txt';
  fileName := replace(fileName, '/', '-', [rfReplaceAll]);
  fileName := replace(fileName, ':', '-', [rfReplaceAll]);
  fileName := logPath + fileName;

  try
    if (fileExists(fileName)) then
      __logFile := openFile(fileName, true)
    else
      __logFile := createFile(fileName);
  except
    writeln('Could not open/create log file');
  end;
end;

{*
__printToLog
~~~~~~~~~~~~

.. code-block:: pascal

    procedure printToLog(s : string);

Writes the string 's' to the SRL log file.

.. note::

    by Markus
    Last Modified: Feb. 20th, 2012 by Coh3n

Example:

.. code-block:: pascal

    printToLog('Adding to SRL log file!');

*}
procedure __printToLog(s: string);
begin
  if (disableSRLLog) then
    exit;

  if (__logFile >= 0) then
    try
      writeFileString(__logFile, '['+msToTime(getTimeRunning(), TIME_BARE)+']: '+s+#13+#10);
    except
      writeln('Could not write to log file');
    end;
end;

{*
__closeLogFile
~~~~~~~~~~~~~~

.. code-block:: pascal

    procedure __closeLogFile();

Closes the log file.

.. note::

    by Coh3n
    Last Modified: 13 April 2013 by Coh3n

Example:

.. code-block:: pascal

    __closeLogFile();

*}
procedure __closeLogFile();
begin
  if (disableSRLLog) then
    exit;

  try
    closeFile(__logFile);
  except
    writeln('Error closing log file');
  end;
end;

(*
print
~~~~~

.. code-block:: pascal

    procedure print(txt: string; debugType: TDebug = TDebug.DEBUG);

Prints txt to the debug box if debugType doesn't equal TDebug.LOG.  Will always
print to the log file unless disableSRLLog is set to true.  Valid arguements
for debugType:
    * DEBUG (default)
    * LOG
    * HINT
    * WARNING
    * ERROR
    * HEADER
    * FOOTER
    * SUB

.. note::

    by Coh3n & masterBB
    Last Modified: 24 May 2013 by Coh3n

Example:

.. code-block:: pascal

    print(TheDate);

*)
procedure print(txt: string; debugType: TDebug = TDebug.DEBUG);
var
  debugMSG: string;
begin
  case debugType of
    TDebug.HINT:
      txt := 'HINT: ' + txt;

    TDebug.WARNING:
      txt := 'WARNING: ' + txt;

    TDebug.ERROR:
      txt := 'ERROR: ' + txt;

    TDebug.FATAL:
      txt := 'FATAL ERROR: ' + txt;

    TDebug.FOOTER:
      dec(__debugLevel);

    TDebug.SUB:
      inc(__debugLevel);
  end;

  debugMSG := replicate('--', __debugLevel) + ' ' + txt;

  // check for header after the case because the debugMSG needs to
  // be calculated BEFORE __debugLevel is changed
  if (debugType = TDebug.HEADER) then
    inc(__debugLevel);

  // reset the debug level
  if (debugType = TDebug.SUB) then
    dec(__debugLevel);

  if (not disableSRLLog) then
  begin
    if (__logFile = -1) then // if it hasn't yet been created
      __openLogFile();

    __printToLog(debugMSG);
  end;

  // print the fatal error and terminate the script
  if (debugType = TDebug.FATAL) then
  begin
    writeln(debugMSG);
    terminateScript();
  end;

  if (disableSRLDebug) then
    exit;

  if (debugType <> TDebug.LOG) then
    writeln(debugMSG);
end;

(*
debugBitmap
~~~~~~~~~~~

.. code-block:: pascal

    procedure debugBitmap(Bmp: Integer);

Shows a bitmap in the debug image window.

.. note::

    by Cazax
    Last Updated: 12 April 2013 by Coh3n

Example:

.. code-block:: pascal

    debugBitmap(bmp);
*)
procedure debugBitmap(Bmp: Integer);
var
  W, H: Integer;
begin
  try
    GetBitmapSize(Bmp, W, H);
    DisplayDebugImgWindow(W, H);
    DrawBitmapDebugImg(Bmp);
  except
    print('Error in DebugBitmap', TDebug.error);
  end;
end;

procedure debugATPA(const atpa: T2DPointArray);
var
  tmb: TMufasaBitmap;
  b: TBox;
begin
  b := getATPABounds(atpa);

  tmb.init(client.getMBitmaps());
  tmb.setSize(b.x2+1, b.y2+1);
  tmb.drawATPA(atpa);

  tmb.debug();
  tmb.free();
end;

procedure debugATPABounds(const atpa: T2DPointArray);
var
  tmb: TMufasaBitmap;
  b: TBox;
begin
  b := getATPABounds(atpa);

  tmb.init(client.getMBitmaps());
  tmb.setSize(b.x2+1, b.y2+1);
  tmb.debugATPA(atpa);

  tmb.debug();
  tmb.free();
end;

procedure debugTPA(const tpa: TPointArray);
var
  tmb: TMufasaBitmap;
  b: TBox;
begin
  b := getTPABounds(tpa);

  tmb.init(client.getMBitmaps());
  tmb.setSize(b.x2+1, b.y2+1);
  tmb.debugTPA(tpa);

  tmb.debug();
  tmb.free();
end;

(*
takeScreenshot
~~~~~~~~~~~~~~

.. code-block:: pascal

    procedure takeScreenshot(fileName: string);

Saves a screenshot to fileName, and adds the time to avoid replacing images.

.. note::

    by Harry & Coh3n
    Last updated: Feb. 09, 2013 by Coh3n

Example:

.. code-block:: pascal

    takeScreenshot('example.png');
*)
procedure takeScreenshot(fileName: string);
begin
  saveScreenshot(logPath + timeRunning() + '_' + fileName);
  print('Saving screenshot: '+fileName, TDebug.SUB);
end;

begin
  setScriptProp(SP_WriteTimeStamp, [addTimeStamp]);
  addOnTerminate('__closeLogFile');
end;

